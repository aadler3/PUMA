---
title: "PUMA Modeling Analysis"
output: html_document
date: "2025-04-21"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Set up
```{r, include=FALSE}
#load packages
library(dplyr)
library(flextable)
library(ggplot2)
library(collapse)
library(labelled)
library(compareGroups)
library(gee)
library(geepack)
library(pROC)
library(ROCR)
library(plotROC)
library(gridExtra)
library(kableExtra)
library(ggalluvial)
library(sandwich) #for robust standard errors
#install.packages("msm") #NOTE: when installing msm if you get the question "Do you want to install from sources the package which needs compilation?" type "no"
library(msm) #for delta method 
library(lmtest)
```

# Load Data and Source Functions
```{r}
pathway <- "~/Library/CloudStorage/Box-Box/Puma Analysis/Analysis/Code"
month12 <- readRDS(file.path(pathway, "/RDS/puma_month12.rds"))
puma_all <- readRDS(file.path(pathway, "/RDS/puma_long_clean.rds"))
secondary_long <- readRDS(file.path(pathway, "/RDS/puma_secondary_long.rds"))

output_path <- "~/Library/CloudStorage/Box-Box/Puma Analysis/Analysis/Code/Output"

source("analysis_utilities.R")
```

# Prepare Data for GEE models
```{r}
# Create dataframes for the GEE models section
## Hair
hair_gee_data <- prepare_gee_data(
  puma_all, 
  outcome = "detect_tfv", 
  predictors = c("wilson_adh_scaled_sd", "group_new"),
  additional_vars = c("wilson_adh10", "wilson_adh", "STRAND_hair", "STRAND_hair_bin",
                      "hair3code", "hair2code", "hair2_coded", "hair3numeric",
                      "emp_coded", "age", "edu", "visit_coded")
)


## Urine
ut_gee_data <- prepare_gee_data(
  puma_all, 
  outcome = "ut_result", 
  predictors = c("wilson_adh_scaled_sd", "group_new"),
  additional_vars = c("wilson_adh", "wilson_adh10", "emp_coded", "age", "edu", "visit_coded")
)

## Continuous hair
continuous_data <- prepare_gee_data(
  puma_all, 
  outcome = "tfvngml", 
  predictors = c("wilson_adh_scaled_sd", "group_new"),
  additional_vars = c("wilson_adh", "wilson_adh10", "ptid", "visit", "detect_tfv")
)

## POC all
poc_all <- prepare_gee_data(
  puma_all, 
  outcome = "ut_result", 
  predictors = c("wilson_adh_scaled_sd", "group_new"),
  additional_vars = c("wilson_adh", "wilson_adh10", "ptid", "visit", "detect_tfv")
)

poc_all <- poc_all %>% filter(group_new == "Intervention")

## SOC all
soc_all <- prepare_gee_data(
  puma_all, 
  outcome = "ut_result", 
  predictors = c("wilson_adh_scaled_sd", "group_new"),
  additional_vars = c("wilson_adh", "wilson_adh10", "ptid", "visit", "detect_tfv")
)

soc_all <- soc_all %>% filter(group_new == "Standard of Care")

secondary_long <- secondary_long %>% mutate(STRAND_hair_bin_coded = ifelse(STRAND_hair_bin == ">= 4", 1, 0))

```

# Hair -- Binary (0/1)
## Adherence Scaled by Standard Deviation
```{r}
hair_sd_results <- run_gee_model(
  hair_gee_data,
  outcome = "detect_tfv",
  predictors = c("wilson_adh_scaled_sd", "group_new")
)

flextable(hair_sd_results)
```

## Adherence Not-Scaled
```{r}
hair_results <- run_gee_model(
  hair_gee_data,
  outcome = "detect_tfv",
  predictors = c("wilson_adh", "group_new")
)

flextable(hair_results)
```

## Adherence Scaled by Factor of 10
```{r}
hair_10_results <- run_gee_model(
  hair_gee_data,
  outcome = "detect_tfv",
  predictors = c("wilson_adh10", "group_new")
)

flextable(hair_10_results)
```

# Hair -- Continuous
## Adherence Scaled by Standard Deviation
```{r}
# Association between adherence and continuous hair levels
# Linear regression with a GEE model 
# Association between adherence and continuous hair levels
hair_cont_results <- run_gee_continuous_model(
  continuous_data,
  outcome = "tfvngml",
  predictors = c("wilson_adh_scaled_sd", "group_new")
)

flextable(hair_cont_results)

```

# Hair -- Categorical with 3 codes (< 2 doses, 2-3 doses, >= 4 doses)
## Adherence Scaled by Standard Deviation
```{r}
hair_3cat_results <- run_gee_model(
  hair_gee_data,
  outcome = "hair3numeric",
  predictors = c("wilson_adh_scaled_sd", "group_new")
)

flextable(hair_3cat_results)
```

# Hair -- Categorical with 2 codes (High [1; >= 4 doses] vs Low [0; <= 3 doses])
## Adherence Scaled by Standard Deviation
```{r}
hair_gee_data <- hair_gee_data %>% mutate(STRAND_hair_bin_coded = ifelse(STRAND_hair_bin == ">= 4", 1, 0))

hair_2cat_results <- run_gee_model(
  hair_gee_data,
  outcome = "STRAND_hair_bin_coded",
  predictors = c("wilson_adh_scaled_sd", "group_new")
)

flextable(hair_2cat_results)
```

# Urine -- Binary (0/1)
## Adherence Scaled by Standard Deviation
```{r}
# Urine model with scaled_sd
ut_sd_results <- run_gee_model(
  ut_gee_data,
  outcome = "ut_result",
  predictors = c("wilson_adh_scaled_sd", "group_new")
)

flextable(ut_sd_results)
```

## Adherence Not-Scaled
```{r}
urine_results <- run_gee_model(
  ut_gee_data,
  outcome = "ut_result",
  predictors = c("wilson_adh", "group_new")
)

flextable(urine_results)
```

## Adherence Scaled by Factor of 10
```{r}
ut_10_results <- run_gee_model(
  ut_gee_data,
  outcome = "ut_result",
  predictors = c("wilson_adh10", "group_new")
)

flextable(ut_10_results)
```

# Multivariate Analysis
## Univariable Analysis 
```{r}
# List of predictor variables selected a priori
# predictors <- c("wilson_adh", "wilson_adh_scaled_sd", "padh4", "padh7",
#                 "ppoz_coded", "marital", "income", "travel_coded", 
#                 "incsource_coded", "edu", "emp_coded", "mh14", "sex1", 
#                 "prep_length", "condomless_sex", "sex14", "age")
# 

# # List of outcome variables
# outcomes <- c("ut_result", "STRAND_hair_bin_coded")
# 
# # Run univariable analysis
# univariable_results <- run_univariable_analysis(
#   data = secondary_long,
#   predictors = predictors,
#   outcomes = outcomes
# )
# 
# # Get summary of significant predictors
# significant_predictors <- summarize_univariable_results(univariable_results)
# 
# # Display the full results table
# print(univariable_results)
# ## Associated univariable with ut:
# ### emp_coded, age
# 
# ## Associated univariable with detect_tfv
# ### edu 
```

## Univariable Models with Signficiant Associated Variables
### Urine
```{r}
## emp_coded
emp_results <- run_gee_model(
  secondary_long,
  outcome = "ut_result",
  predictors = c("emp_coded")
)

flextable(emp_results)

## age
age_results <- run_gee_model(
  secondary_long,
  outcome = "ut_result",
  predictors = c("age")
)

flextable(age_results)
```

### Hair
```{r}
## edu
edu_results <- run_gee_model(
  secondary_long,
  outcome = "STRAND_hair_bin_coded",
  predictors = c("edu")
)

flextable(edu_results)

## age
age_results_h <- run_gee_model(
  secondary_long,
  outcome = "STRAND_hair_bin_coded",
  predictors = c("age")
)

flextable(age_results_h)
```

## Forward Selection with Significant Variables
### Urine
```{r}
forward_selection_vars <- c("edu", "emp_coded", "age", "hair2_coded", "ut_result", 
                            "group_new", "wilson_adh_scaled_sd", "ptid")

multivar_data <- secondary_long %>% select(edu, emp_coded, age, ut_result, 
                            group_new, wilson_adh_scaled_sd, ptid, STRAND_hair_bin_coded)
### Urine Assay
# Remove NAs
multivar_data <-multivar_data[complete.cases(multivar_data),]
ut_multivar <- multivar_data %>% select(-STRAND_hair_bin_coded)

## Manual stepwise

# Start with minimum model
min_model_multivar <- geeglm(ut_result ~ group_new,
                id = ptid,
                family = poisson(link = "log"),
                corstr = "exchangeable",
                data = ut_multivar)
QIC(min_model_multivar)

# Add in Wilson ADH
wilson_model_multivar <- geeglm(ut_result ~ group_new + wilson_adh_scaled_sd,
                id = ptid,
                family = poisson(link = "log"),
                corstr = "exchangeable",
                data = ut_multivar)
QIC(wilson_model_multivar)

# Add in employment status 
emp_model_multivar <- geeglm(ut_result ~ group_new + wilson_adh_scaled_sd + emp_coded,
                id = ptid,
                family = poisson(link = "log"),
                corstr = "exchangeable",
                data = ut_multivar)
# QIC is higher thn just Wilson ADH
QIC(emp_model_multivar)

# Remove emp and add in age
age_model_multivar <- geeglm(ut_result ~ group_new + wilson_adh_scaled_sd + age,
                id = ptid,
                family = poisson(link = "log"),
                corstr = "exchangeable",
                data = ut_multivar)
# Compare QICs
QIC(wilson_model_multivar)
# Age is lower 
QIC(age_model_multivar)

# Add all in
full_model_multivar <- geeglm(ut_result ~ group_new + emp_coded + age + wilson_adh_scaled_sd,
                id = ptid,
                family = poisson(link = "log"),
                corstr = "exchangeable",
                data = ut_multivar)
# Adding in emp has higher QIC
QIC(full_model_multivar)

## Print full model with age
full_m_ut <- run_gee_model(
  secondary_long,
  outcome = "ut_result",
  predictors = c("group_new", "wilson_adh_scaled_sd", "age")
)

flextable(full_m_ut)
```

### Hair Forward Selection
```{r}
### Urine Assay
# Remove NAs
multivar_data <-multivar_data[complete.cases(multivar_data),]
hr_multivar <- multivar_data %>% select(-ut_result)

## Manual stepwise

# Start with minimum model
min_model_hr <- geeglm(hair2_coded ~ group_new,
                id = ptid,
                family = poisson(link = "log"),
                corstr = "exchangeable",
                data = hr_multivar)
QIC(min_model_hr)

# Add in Wilson ADH
wilson_model_hr <- geeglm(hair2_coded ~ group_new + wilson_adh_scaled_sd,
                id = ptid,
                family = poisson(link = "log"),
                corstr = "exchangeable",
                data = hr_multivar)
QIC(wilson_model_hr)

# Add in edu
edu_model_hr <- geeglm(hair2_coded ~ group_new + wilson_adh_scaled_sd + edu,
                id = ptid,
                family = poisson(link = "log"),
                corstr = "exchangeable",
                data = hr_multivar)
# QIC is lower than just Wilson ADH
QIC(edu_model_hr)

# Just edu by itself
edu_model2_hr <- geeglm(hair2_coded ~ group_new + edu,
                id = ptid,
                family = poisson(link = "log"),
                corstr = "exchangeable",
                data = hr_multivar)
# QIC is higher than above
QIC(edu_model2_hr)

# Add in age
age_edu_model_hr <- geeglm(hair2_coded ~ group_new + wilson_adh_scaled_sd + edu + age,
                id = ptid,
                family = poisson(link = "log"),
                corstr = "exchangeable",
                data = hr_multivar)
# QIC is lower than just Wilson ADH
QIC(age_edu_model_hr)

## Print full model with education status
full_m_hr <- run_gee_model(
  secondary_long,
  outcome = "hair2_coded",
  predictors = c("group_new", "wilson_adh_scaled_sd", "edu")
)

flextable(full_m_hr)
```

## Full Models for Both Results
```{r}
#Urine
model_ut <- run_gee_model(
  secondary_long,
  outcome = "ut_result",
  predictors = c("group_new", "wilson_adh_scaled_sd", "edu", "age")
)

flextable(model_ut)

## Check QIC using geeglm
m_ut_glm <- geeglm(ut_result ~ group_new + edu + age + wilson_adh_scaled_sd,
                id = ptid,
                family = poisson(link = "log"),
                corstr = "exchangeable",
                data = secondary_long)
QIC(m_ut_glm)

#Hair
m_hair <- run_gee_model(
  secondary_long,
  outcome = "STRAND_hair_bin_coded",
  predictors = c("group_new", "wilson_adh_scaled_sd", "edu", "age")
)

flextable(m_hair)

## Check QIC using geeglm
mhair_glm <- geeglm(STRAND_hair_bin_coded ~ group_new + edu + age + wilson_adh_scaled_sd,
                id = ptid,
                family = poisson(link = "log"),
                corstr = "exchangeable",
                data = hr_multivar)
QIC(mhair_glm)
```

# Stratified Analysis
## Hair
```{r}
# Filter data for analysis (identical to original)
hair_gee_data <- puma_all %>%
  filter(complete.cases(detect_tfv, wilson_adh, group_new, ptid)) %>% 
  select(detect_tfv, wilson_adh_scaled_sd, wilson_adh10, 
         group_new, ptid, wilson_adh, mh14, hair3numeric)

# Analyze intervention group
hair_poc_results <- run_group_specific_gee(
  data = hair_gee_data,
  outcome = "detect_tfv",
  predictor = "wilson_adh_scaled_sd",
  group_var = "group_new",
  group_value = "Intervention"
)

# Display results
flextable(hair_poc_results)

# Analyze standard of care group
hair_soc_results <- run_group_specific_gee(
  data = hair_gee_data,
  outcome = "detect_tfv",
  predictor = "wilson_adh_scaled_sd",
  group_var = "group_new",
  group_value = "Standard of Care"
)

# Display results
flextable(hair_soc_results)
```

## Urine 
```{r}
# Filter data for urine analysis (identical to original)
ut_gee_data <- puma_all %>%
  filter(complete.cases(ut_result, wilson_adh, group_new, ptid)) %>% 
  select(ut_result, wilson_adh_scaled_sd, wilson_adh10, 
         group_new, ptid, wilson_adh, mh14)

# Analyze standard of care group
ut_soc_results <- run_group_specific_gee(
  data = ut_gee_data,
  outcome = "ut_result",
  predictor = "wilson_adh_scaled_sd",
  group_var = "group_new",
  group_value = "Standard of Care"
)

# Display results
flextable(ut_soc_results)

# Analyze intervention group
ut_poc_results <- run_group_specific_gee(
  data = ut_gee_data,
  outcome = "ut_result",
  predictor = "wilson_adh_scaled_sd",
  group_var = "group_new",
  group_value = "Intervention"
)

# Display results
flextable(ut_poc_results)
```

## Interaction Tests for Difference between 
```{r}
# Run interaction test for urine
ut_lrt_results <- run_group_interaction_test(
  data = ut_gee_data,
  outcome = "ut_result",
  predictor = "wilson_adh_scaled_sd",
  group_var = "group_new"
)

# Display results
flextable(ut_lrt_results)

```

## Basline Model (hair)
```{r}
baseline <- puma_all %>% filter(visit == 1)

m_baseline_hair <- glm(hair2_coded ~ wilson_adh_scaled_sd + group_new, family="poisson", data=baseline)
summary(m_baseline_hair) 

#robust standard errors
cov.m_baseline_hair <- vcovHC(m_baseline_hair, type="HC0")
std.err.m_baseline_hair <- sqrt(diag(cov.m_baseline_hair))
r.est.m_baseline_hair <- cbind(Estimate= coef(m_baseline_hair), "Robust SE" = std.err.m_baseline_hair,
"Pr(>|z|)" = 2 * pnorm(abs(coef(m_baseline_hair)/std.err.m_baseline_hair), lower.tail=FALSE),
LL = coef(m_baseline_hair) - 1.96 * std.err.m_baseline_hair,
UL = coef(m_baseline_hair) + 1.96 * std.err.m_baseline_hair)

r.est.m_baseline_hair 

#above results on the log scale, we want IRR, so need to exponentiate our results
#use the delta method
s_m_baseline_hair <- deltamethod(list(~ exp(x1), ~ exp(x2), ~ exp(x3)), coef(m_baseline_hair), cov.m_baseline_hair)

## exponentiate old estimates dropping the p values in column 3
rexp.m_baseline_hair <- exp(r.est.m_baseline_hair [, -3])
## replace SEs with estimates for exponentiated coefficients
rexp.m_baseline_hair[, "Robust SE"] <- s_m_baseline_hair

rexp.m_baseline_hair

baseline_high <- baseline %>% filter(hair2_coded == 1)
summary(baseline_high$wilson_adh)
baseline_low <- baseline %>% filter(hair2_coded == 0)
summary(baseline_low$wilson_adh)
```

## Month 12 model (hair)
```{r}
m_m12_hair <- glm(hair2_coded ~ wilson_adh_scaled_sd + group_new, family="poisson", data=month12)
summary(m_m12_hair) 

#robust standard errors
cov.m_m12_hair <- vcovHC(m_m12_hair, type="HC0")
std.err.m_m12_hair <- sqrt(diag(cov.m_m12_hair))
r.est.m_m12_hair <- cbind(Estimate= coef(m_m12_hair), "Robust SE" = std.err.m_m12_hair,
"Pr(>|z|)" = 2 * pnorm(abs(coef(m_m12_hair)/std.err.m_m12_hair), lower.tail=FALSE),
LL = coef(m_m12_hair) - 1.96 * std.err.m_m12_hair,
UL = coef(m_m12_hair) + 1.96 * std.err.m_m12_hair)

r.est.m_m12_hair 

#above results on the log scale, we want IRR, so need to exponentiate our results
#use the delta method
s_m_m12_hair <- deltamethod(list(~ exp(x1), ~ exp(x2), ~ exp(x3)), coef(m_m12_hair), cov.m_m12_hair)

## exponentiate old estimates dropping the p values in column 3
rexp.m_m12_hair <- exp(r.est.m_m12_hair[, -3])
## replace SEs with estimates for exponentiated coefficients
rexp.m_m12_hair[, "Robust SE"] <- s_m_m12_hair

rexp.m_m12_hair

month12_high <- month12 %>% filter(hair2_coded == 1)
summary(month12_high$wilson_adh)
month12_low <- month12 %>% filter(hair2_coded == 0)
summary(month12_low$wilson_adh)
```
## Difference Between Models
```{r}

```


## Basline Model (urine)
```{r}
m_baseline_ut <- glm(ut_result ~ wilson_adh_scaled_sd + group_new, family="poisson", data=baseline)
summary(m_baseline_ut) 

#robust standard errors
cov.m_baseline_ut <- vcovHC(m_baseline_ut, type="HC0")
std.err.m_baseline_ut <- sqrt(diag(cov.m_baseline_ut))
r.est.m_baseline_ut <- cbind(Estimate= coef(m_baseline_ut), "Robust SE" = std.err.m_baseline_ut,
"Pr(>|z|)" = 2 * pnorm(abs(coef(m_baseline_ut)/std.err.m_baseline_ut), lower.tail=FALSE),
LL = coef(m_baseline_ut) - 1.96 * std.err.m_baseline_ut,
UL = coef(m_baseline_ut) + 1.96 * std.err.m_baseline_ut)

r.est.m_baseline_ut 

#above results on the log scale, we want IRR, so need to exponentiate our results
#use the delta method
s_m_baseline_ut <- deltamethod(list(~ exp(x1), ~ exp(x2), ~ exp(x3)), coef(m_baseline_ut), cov.m_baseline_ut)

## exponentiate old estimates dropping the p values in column 3
rexp.m_baseline_ut <- exp(r.est.m_baseline_ut [, -3])
## replace SEs with estimates for exponentiated coefficients
rexp.m_baseline_ut[, "Robust SE"] <- s_m_baseline_ut

rexp.m_baseline_ut

baseline_pos <- baseline %>% filter(ut_result == 1)
summary(baseline_pos$wilson_adh)
baseline_neg <- baseline %>% filter(ut_result == 0)
summary(baseline_neg$wilson_adh)
```

## Week 12 model (urine)
```{r}
m_m12_ut <- glm(ut_result ~ wilson_adh_scaled_sd + group_new, family="poisson", data=month12)
summary(m_m12_ut) 

#robust standard errors
cov.m_m12_ut <- vcovHC(m_m12_ut, type="HC0")
std.err.m_m12_ut <- sqrt(diag(cov.m_m12_ut))
r.est.m_m12_ut <- cbind(Estimate= coef(m_m12_ut), "Robust SE" = std.err.m_m12_ut,
"Pr(>|z|)" = 2 * pnorm(abs(coef(m_m12_ut)/std.err.m_m12_ut), lower.tail=FALSE),
LL = coef(m_m12_ut) - 1.96 * std.err.m_m12_ut,
UL = coef(m_m12_ut) + 1.96 * std.err.m_m12_ut)

r.est.m_m12_ut 

#above results on the log scale, we want IRR, so need to exponentiate our results
#use the delta method
s_m_m12_ut <- deltamethod(list(~ exp(x1), ~ exp(x2), ~ exp(x3)), coef(m_m12_ut), cov.m_m12_ut)

## exponentiate old estimates dropping the p values in column 3
rexp.m_m12_ut <- exp(r.est.m_m12_ut[, -3])
## replace SEs with estimates for exponentiated coefficients
rexp.m_m12_ut[, "Robust SE"] <- s_m_m12_ut

rexp.m_m12_ut

month12_pos <- month12 %>% filter(ut_result == 1)
summary(month12_pos$wilson_adh)
month12_neg <- month12 %>% filter(ut_result == 0)
summary(month12_neg$wilson_adh)
```

# Dose Response Model for P-Values
## Urine
```{r}
dose_response_m <- glm(ut_result ~ group_new + wilson_adh_scaled_sd*visit_coded, family="poisson", data=ut_gee_data)
summary(dose_response_m) 

#robust standard errors
cov.dose_response_m <- vcovHC(dose_response_m, type="HC0")
std.err.dose_response_m <- sqrt(diag(cov.dose_response_m))
r.est.dose_response_m <- cbind(Estimate= coef(dose_response_m), "Robust SE" = std.err.dose_response_m,
"Pr(>|z|)" = 2 * pnorm(abs(coef(dose_response_m)/std.err.dose_response_m), lower.tail=FALSE),
LL = coef(dose_response_m) - 1.96 * std.err.dose_response_m,
UL = coef(dose_response_m) + 1.96 * std.err.dose_response_m)

r.est.dose_response_m 
```

## Hair
```{r}
dose_response_m_hair <- glm(hair2_coded ~ group_new + wilson_adh_scaled_sd*visit_coded, family="poisson", data=hair_gee_data)
summary(dose_response_m_hair) 

#robust standard errors
cov.dose_response_m_hair <- vcovHC(dose_response_m_hair, type="HC0")
std.err.dose_response_m_hair <- sqrt(diag(cov.dose_response_m_hair))
r.est.dose_response_m_hair <- cbind(Estimate= coef(dose_response_m_hair), "Robust SE" = std.err.dose_response_m_hair,
"Pr(>|z|)" = 2 * pnorm(abs(coef(dose_response_m_hair)/std.err.dose_response_m_hair), lower.tail=FALSE),
LL = coef(dose_response_m_hair) - 1.96 * std.err.dose_response_m_hair,
UL = coef(dose_response_m_hair) + 1.96 * std.err.dose_response_m_hair)

r.est.dose_response_m_hair 
```

# Ordinal Logistic Regression
```{r}
summary(puma_all$wilson_adh)
hist(puma_all$wilson_adh)
```

