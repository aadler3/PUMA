---
title: "PUMA Analysis"
output: html_document
date: "2025-02-11"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Source all supporting files
source("utils.R")
source("data_processing.R")
source("models.R")
source("visualizations.R")
source("tables.R")

# Load packages
load_packages()
```

# Load and Process Data

```{r}
# Load raw data
puma_all <- load_puma_data()

# Process data and create new variables
puma_all <- process_puma_data(puma_all)

# Create subset datasets for specific analyses
subsets <- create_subset_data(puma_all)
baseline <- subsets$baseline
month12 <- subsets$month12
poc_all <- subsets$poc_all
soc_all <- subsets$soc_all

# Create analysis datasets
analysis_datasets <- create_analysis_datasets(puma_all)

# Extract analysis datasets
hair_long <- analysis_datasets$hair_long
hair_wide <- analysis_datasets$hair_wide
ut_long <- analysis_datasets$ut_long
ut_wide <- analysis_datasets$ut_wide
adherence <- analysis_datasets$adherence
adherence_wide <- analysis_datasets$adherence_wide
primary_long <- analysis_datasets$primary_long
primary_wide <- analysis_datasets$primary_wide
hair_gee_data <- analysis_datasets$hair_gee_data
ut_gee_data <- analysis_datasets$ut_gee_data

# Create table1 data
table1_data <- create_table1_data(baseline)
```

# Table 1 - Baseline Characteristics

```{r}
# Generate Table 1
table1_results <- generate_table1(table1_data)

# Display tables
table1_results$demographics_by_arm
table1_results$sexual_behavior_by_arm
```

# Descriptive Statistics Over Study Period

## Hair Levels

```{r}
# Binary variable analysis
hair_table_binary <- generate_hair_table(puma_all)

# Display binary results
print("Hair Level Categorized Into 3 Levels")
print(hair_table_binary$visit_1$overall$counts)
print(paste0("Percentage: ", hair_table_binary$visit_1$overall$percentages, "%"))

# Chi-squared test for group differences at each visit
for (i in 1:5) {
  table_data <- table(hair_wide$group, hair_wide[[paste0("detect_tfv.", i)]])
  test_result <- chisq.test(table_data)
  cat("\nChi-squared test for visit", i, ":\n")
  print(test_result)
}

# Categorical hair level analysis
print("Hair Levels by Study Arm and Visit")
hair_table_categorical <- generate_hair_table(puma_all)

# Hair levels with BLQ
print("Hair Levels with BLQ by Study Arm and Visit")
hair_blq_table <- generate_hair_blq_table(puma_all)

# Continuous hair levels
print("Continuous Hair Levels (TFV ng/ml)")
hair_continuous <- generate_hair_continuous_summary(puma_all)
```

## Urine Assay Results

```{r}
# Calculate overall positive results by visit
for (i in 1:5) {
  positive_rate <- sum(ut_wide[[paste0("ut_result.", i)]], na.rm = TRUE) / 
    sum(!is.na(ut_wide[[paste0("ut_result.", i)]]))
  cat("Visit", i, "positive rate:", round(positive_rate * 100, 1), "%\n")
  cat("Missing data:", sum(is.na(ut_wide[[paste0("ut_result.", i)]]), "\n\n")
}

# Chi-squared test for group differences at each visit
for (i in 1:5) {
  table_data <- table(ut_wide$group_new, ut_wide[[paste0("ut_result.", i)]])
  test_result <- chisq.test(table_data)
  cat("\nChi-squared test for visit", i, ":\n")
  print(test_result)
}

# Group comparison over time - GEE model
gee_model <- geeglm(ut_result ~ factor(visit) * factor(group_new),
                   family = binomial(link = "logit"),
                   id = ptid,
                   corstr = "independence",
                   data = ut_long)

summary(gee_model)
```

## Self-reported Adherence

```{r}
# Generate adherence summary tables
adherence_summary <- generate_adherence_summary(adherence_wide)

# Display Wilson adherence results
print("Wilson Adherence Score Summary")
print(adherence_summary$wilson_adh)

# T-test results
cat("\nT-test Results for Wilson Adherence by Group:\n")
for (i in 1:5) {
  test_result <- adherence_summary$t_tests[[paste0("wilson_visit", i)]]
  cat("Visit", i, "p-value:", format.pval(test_result$p.value, digits = 3), "\n")
}
```

## Study Retention

```{r}
# Generate retention table
retention_results <- generate_retention_table(primary_wide)

# Display retention rates
cat("Total participants at each visit:\n")
print(retention_results$total)

cat("\nIntervention arm retention:\n")
print(retention_results$intervention$percentages)

cat("\nControl arm retention:\n")
print(retention_results$control$percentages)
```

# Statistical Models

## Hair and Adherence Association

```{r}
# Run hair models with different scaling methods
hair_model_sd <- run_hair_model(hair_gee_data, scale_method = "sd")
hair_model_10 <- run_hair_model(hair_gee_data, scale_method = "10")
hair_model_unscaled <- run_hair_model(hair_gee_data, scale_method = "unscaled")

# Format and display results
hair_results_sd <- format_gee_results(hair_model_sd)
hair_results_10 <- format_gee_results(hair_model_10)
hair_results_unscaled <- format_gee_results(hair_model_unscaled)

flextable::flextable(hair_results_sd)
flextable::flextable(hair_results_10)
```

## Urine and Adherence Association

```{r}
# Run urine models with different scaling methods
urine_model_sd <- run_urine_model(ut_gee_data, scale_method = "sd")
urine_model_10 <- run_urine_model(ut_gee_data, scale_method = "10")
urine_model_unscaled <- run_urine_model(ut_gee_data, scale_method = "unscaled")

# Format and display results
urine_results_sd <- format_gee_results(urine_model_sd)
urine_results_10 <- format_gee_results(urine_model_10)
urine_results_unscaled <- format_gee_results(urine_model_unscaled)

flextable::flextable(urine_results_sd)
flextable::flextable(urine_results_10)
```

## Model Selection

```{r}
# Variables to consider for forward selection
predictors <- c("wilson_adh", "wilson_adh_scaled_sd", "padh4", "padh7",
                "ppoz_coded", "marital", "income", "travel_coded", 
                "incsource_coded", "edu", "emp_coded", "mh14", "sex1", 
                "prep_length", "condomless_sex", "sex14", "age")

# Outcomes to model
outcomes <- c("ut_result", "detect_tfv")

# Run univariable analysis
univariable_results <- run_univariable_analysis(
  primary_long, predictors, outcomes)

# Display variables significant at p < 0.2
significant_vars <- univariable_results %>% 
  filter(p_value < 0.2) %>%
  arrange(outcome, p_value)

print(significant_vars)

# Create datasets for model selection
forward_selection_vars <- c("edu", "emp_coded", "age", "detect_tfv", "ut_result", 
                            "group_new", "wilson_adh_scaled_sd", "ptid")

multivar_data <- primary_long[forward_selection_vars]
multivar_data <- multivar_data[complete.cases(multivar_data),]

# Model selection for urine outcome
ut_multivar <- multivar_data %>% select(-detect_tfv)
urine_model_selection <- run_urine_model_selection(ut_multivar)

# Display QIC values for urine models
cat("QIC values for urine models:\n")
print(urine_model_selection$qic_values)
cat("\nBest model:", urine_model_selection$best_model_name, "\n")

# Format and display results for best urine model
best_urine_results <- format_gee_results(urine_model_selection$best_model)
flextable::flextable(best_urine_results)

# Model selection for hair outcome
hr_multivar <- multivar_data %>% select(-ut_result)
hair_model_selection <- run_hair_model_selection(hr_multivar)

# Display QIC values for hair models
cat("QIC values for hair models:\n")
print(hair_model_selection$qic_values)
cat("\nBest model:", hair_model_selection$best_model_name, "\n")

# Format and display results for best hair model
best_hair_results <- format_gee_results(hair_model_selection$best_model)
flextable::flextable(best_hair_results)
```

# Stratified Analysis by Study Group

```{r}
# Separate data by study arm
poc_hair <- hair_gee_data %>% filter(group_new == "Intervention")
soc_hair <- hair_gee_data %>% filter(group_new == "Standard of Care")
poc_ut <- ut_gee_data %>% filter(group_new == "Intervention")
soc_ut <- ut_gee_data %>% filter(group_new == "Standard of Care")

# Run models by study arm - hair
poc_hair_model <- run_hair_model(poc_hair, include_group = FALSE)
soc_hair_model <- run_hair_model(soc_hair, include_group = FALSE)

# Format and display results
poc_hair_results <- format_gee_results(poc_hair_model)
soc_hair_results <- format_gee_results(soc_hair_model)

cat("Intervention arm - hair model results:\n")
flextable::flextable(poc_hair_results)

cat("\nStandard of care arm - hair model results:\n")
flextable::flextable(soc_hair_results)

# Run models by study arm - urine
poc_ut_model <- run_urine_model(poc_ut, include_group = FALSE)
soc_ut_model <- run_urine_model(soc_ut, include_group = FALSE)

# Format and display results
poc_ut_results <- format_gee_results(poc_ut_model)
soc_ut_results <- format_gee_results(soc_ut_model)

cat("Intervention arm - urine model results:\n")
flextable::flextable(poc_ut_results)

cat("\nStandard of care arm - urine model results:\n")
flextable::flextable(soc_ut_results)
```

# ROC Analysis

```{r}
# Run ROC analysis for month 12 data
urine_roc <- run_roc_analysis(month12, "ut_result", "wilson_adh")
hair_roc <- run_roc_analysis(month12, "detect_tfv", "wilson_adh")

# Display AUC values
cat("Urine assay AUC:", round(urine_roc$auc, 3), "\n")
cat("Hair level AUC:", round(hair_roc$auc, 3), "\n")

# Display optimal cutoffs
cat("\nOptimal cutoff for urine assay prediction:", round(urine_roc$best_cutoff, 1), "\n")
cat("Optimal cutoff for hair level prediction:", round(hair_roc$best_cutoff, 1), "\n")
```

# Visualizations

## Adherence Over Time

```{r}
# Create adherence line plot data
line_graph_df <- puma_all %>% dplyr::select(ptid, group_new, wilson_adh, visit)

# Overall adherence plot
adherence_plot_overall <- create_adherence_line_plot(line_graph_df, by_group = FALSE)
print(adherence_plot_overall)

# Group-specific adherence plot
adherence_plot_by_group <- create_adherence_line_plot(line_graph_df, by_group = TRUE)
print(adherence_plot_by_group)
```

## Hair Level Categories and Adherence

```{r}
# Create hair level plots for different time points
baseline_hair_plot <- create_hair_level_plot(baseline, "Baseline")
month6_data <- puma_all %>% filter(visit == 3)
month6_hair_plot <- create_hair_level_plot(month6_data, "Month 6")
month12_hair_plot <- create_hair_level_plot(month12, "Month 12")

# Display plots
print(baseline_hair_plot)
print(month6_hair_plot)
print(month12_hair_plot)

# Combine plots into a grid
gridExtra::grid.arrange(baseline_hair_plot, month6_hair_plot, month12_hair_plot, ncol = 2)
```

## ROC Curves

```{r}
# Plot ROC curves
plot_roc_curves(urine_roc$roc_obj, hair_roc$roc_obj)
```

## Adherence Distribution by Biomarker Results

```{r}
# Create month 12 data for visualization
month12 <- month12 %>% mutate(
  hair_uncoded = factor(ifelse(detect_tfv == 0, "Negative", "Positive"), 
                       levels = c("Negative", "Positive")),
  ut_uncoded = factor(ifelse(ut_result == 0, "Negative", "Positive"), 
                     levels = c("Negative", "Positive"))
)

# Create density plots
hair_density_plot <- create_density_plots(month12, "hair")
urine_density_plot <- create_density_plots(month12, "urine")

# Display plots
print(hair_density_plot)
print(urine_density_plot)

# Create histogram plots
hair_histogram <- create_histogram_plots(month12, "hair")
urine_histogram <- create_histogram_plots(month12, "urine")

# Display plots
print(hair_histogram)
print(urine_histogram)
```


